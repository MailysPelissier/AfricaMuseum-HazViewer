PostgreSQL path : C:\Program Files\PostgreSQL\17
password : password
port : 5432

create extension POSTGIS;

Ajouter couche pays : ne_10m_admin_0_countries.shp (Natural Earth)

Ajouter dans pg Admin :
dans l'invite de commande : 
cd C:\Program Files\PostgreSQL\17\bin
shp2pgsql -s 4326 -c -D -i -I C:\Mailys\data\countries\ne_10m_admin_0_countries.shp countries | psql -h localhost -U postgres -d webGIS

Tables :
- Events v3
- Paragraphs v3
- Table de jointure
- Table events --> Enlever colonnes inutiles : final_cluster, wkt, paragraphs_list, articles_list
- Table paragraphs --> Enlever colonnes inutiles : wkt
- Table citizen_observer coord territoires
- Table citizen_observer

Vue matérialisée :
- Vue paragraphs pg



-- Table: public.events2017_23

DROP TABLE IF EXISTS public.events2017_23;

CREATE TABLE IF NOT EXISTS public.events2017_23
(
    final_cluster real,
    event_id character varying COLLATE pg_catalog."default",
    paragraphs_list character varying COLLATE pg_catalog."default",
    articles_list character varying COLLATE pg_catalog."default",
    n_paragraphs integer,
    n_articles integer,
    hazard_type character varying COLLATE pg_catalog."default",
    hazard_score real,
    latitude real,
    longitude real,
    min_lat real,
    max_lat real,
    min_lon real,
    max_lon real,
    event_time timestamp without time zone,
    start_time timestamp without time zone,
    end_time timestamp without time zone,
    duration integer,
    n_languages integer,
    n_source_countries integer,
    n_domains integer,
    mostfreq_death real,
    n_mostfreq_death real,
    time_mostfreq_death real,
    median_death real,
    mostfreq_homeless real,
    n_mostfreq_homeless real,
    time_mostfreq_homeless real,
    median_homeless real,
    mostfreq_injured real,
    n_mostfreq_injured real,
    time_mostfreq_injured real,
    median_injured real,
    mostfreq_affected real,
    n_mostfreq_affected real,
    time_mostfreq_affected real,
    median_affected real,
    mostfreq_missing real,
    n_mostfreq_missing real,
    time_mostfreq_missing real,
    median_missing real,
    mostfreq_evacuated real,
    n_mostfreq_evacuated real,
    time_mostfreq_evacuated real,
    median_evacuated real,
    wkt character varying COLLATE pg_catalog."default",
    geom geometry(Point,4326),
    primary_key integer NOT NULL GENERATED ALWAYS AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    country_found character varying COLLATE pg_catalog."default",
    CONSTRAINT events2017_23_pkey PRIMARY KEY (primary_key)
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS public.events2017_23
    OWNER to postgres;

-- Index: events2017_23_geom_idx

DROP INDEX IF EXISTS public.events2017_23_geom_idx;

CREATE INDEX IF NOT EXISTS events2017_23_geom_idx
    ON public.events2017_23 USING gist
    (geom)
    WITH (buffering=auto)
    TABLESPACE pg_default;

COPY events2017_23(final_cluster, event_id, paragraphs_list, articles_list, n_paragraphs, n_articles, hazard_type, hazard_score, latitude, longitude, min_lat, max_lat, min_lon, max_lon, event_time, start_time, end_time, duration, n_languages, n_source_countries, n_domains, mostfreq_death, n_mostfreq_death, time_mostfreq_death, median_death, mostfreq_homeless, n_mostfreq_homeless, time_mostfreq_homeless, median_homeless, mostfreq_injured, n_mostfreq_injured, time_mostfreq_injured, median_injured, mostfreq_affected, n_mostfreq_affected, time_mostfreq_affected, median_affected, mostfreq_missing, n_mostfreq_missing, time_mostfreq_missing, median_missing, mostfreq_evacuated, n_mostfreq_evacuated, time_mostfreq_evacuated, median_evacuated)
FROM 'C:/Mailys/data/hazminer/S20170101000000_E20240101000000_GDELT_Events_v3_OPTICS.csv'
DELIMITER ',' 
CSV HEADER
QUOTE '"';

UPDATE events2017_23 SET wkt=concat('POINT (',longitude,' ',latitude,')');
UPDATE events2017_23 SET geom=ST_GeomFromText(wkt);
UPDATE events2017_23 SET country_found = c.admin FROM countries c WHERE ST_Contains(c.geom, events2017_23.geom);

UPDATE events2017_23
SET paragraphs_list = (
  SELECT ARRAY(
    SELECT DISTINCT elem
    FROM UNNEST(string_to_array(regexp_replace(paragraphs_list,'''|\(|\)|\s','','g'),',')::varchar[]) AS elem
  )
);
UPDATE events2017_23
SET articles_list = (
  SELECT ARRAY(
    SELECT DISTINCT elem
    FROM UNNEST(string_to_array(regexp_replace(articles_list,'''|\(|\)|\s','','g'),',')::varchar[]) AS elem
  )
);

UPDATE events2017_23 SET n_paragraphs =  array_length(string_to_array(paragraphs_list, ','), 1);
UPDATE events2017_23 SET n_articles =  array_length(string_to_array(articles_list, ','), 1);



-- Table: public.paragraphs2017_23

DROP TABLE IF EXISTS public.paragraphs2017_23;

CREATE TABLE IF NOT EXISTS public.paragraphs2017_23
(
    article_id character varying COLLATE pg_catalog."default",
    title character varying COLLATE pg_catalog."default",
    extracted_text character varying COLLATE pg_catalog."default",
    paragraph_time timestamp without time zone,
    article_language character varying COLLATE pg_catalog."default",
    source_country character varying COLLATE pg_catalog."default",
    domain_url character varying COLLATE pg_catalog."default",
    paragraph_id character varying COLLATE pg_catalog."default",
    original_text character varying COLLATE pg_catalog."default",
    disaster_label real,
    disaster_score real,
    hazard_type character varying COLLATE pg_catalog."default",
    hazard_type_score real,
    nb_death real,
    score_death real,
    answer_death character varying COLLATE pg_catalog."default",
    nb_homeless real,
    score_homeless real,
    answer_homeless character varying COLLATE pg_catalog."default",
    nb_injured real,
    score_injured real,
    answer_injured character varying COLLATE pg_catalog."default",
    nb_affected real,
    score_affected real,
    answer_affected character varying COLLATE pg_catalog."default",
    nb_missing real,
    score_missing real,
    answer_missing character varying COLLATE pg_catalog."default",
    nb_evacuated real,
    score_evacuated real,
    answer_evacuated character varying COLLATE pg_catalog."default",
    publication_time timestamp without time zone,
    extracted_location character varying COLLATE pg_catalog."default",
    ner_score character varying COLLATE pg_catalog."default",
    latitude real,
    longitude real,
    std_dev real,
    min_lat real,
    max_lat real,
    min_lon real,
    max_lon real,
    n_locations real,
    nb_death_min real,
    nb_death_max real,
    nb_homeless_min real,
    nb_homeless_max real,
    nb_injured_min real,
    nb_injured_max real,
    nb_affected_min real,
    nb_affected_max real,
    nb_missing_min real,
    nb_missing_max real,
    nb_evacuated_min real,
    nb_evacuated_max real,
    continent character varying COLLATE pg_catalog."default",
    country character varying COLLATE pg_catalog."default",
    population_density real,
    wkt character varying COLLATE pg_catalog."default",
    geom geometry(Point,4326),
    primary_key integer NOT NULL GENERATED ALWAYS AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    country_found character varying COLLATE pg_catalog."default",
    CONSTRAINT paragraphs2017_23_pkey PRIMARY KEY (primary_key)
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS public.paragraphs2017_23
    OWNER to postgres;
	
-- Index: paragraphs2017_23_geom_idx

DROP INDEX IF EXISTS public.paragraphs2017_23_geom_idx;

CREATE INDEX IF NOT EXISTS paragraphs2017_23_geom_idx
    ON public.paragraphs2017_23 USING gist
    (geom)
    WITH (buffering=auto)
    TABLESPACE pg_default;
	
-- Index: paragraphs2017_23_paragraph_id_idx

DROP INDEX IF EXISTS public.paragraphs2017_23_paragraph_id_idx;

CREATE INDEX IF NOT EXISTS paragraphs2017_23_paragraph_id_idx
    ON public.paragraphs2017_23 USING btree
    (paragraph_id ASC NULLS LAST)
    TABLESPACE pg_default;

COPY paragraphs2017_23(article_id, title, extracted_text, paragraph_time, article_language, source_country, domain_url, paragraph_id, original_text, disaster_label, disaster_score, hazard_type, hazard_type_score, nb_death, score_death, answer_death, nb_homeless, score_homeless, answer_homeless, nb_injured, score_injured, answer_injured, nb_affected, score_affected, answer_affected, nb_missing, score_missing, answer_missing, nb_evacuated, score_evacuated, answer_evacuated, publication_time, extracted_location, ner_score, latitude, longitude, std_dev, min_lat, max_lat, min_lon, max_lon, n_locations, nb_death_min, nb_death_max, nb_homeless_min, nb_homeless_max, nb_injured_min, nb_injured_max, nb_affected_min, nb_affected_max, nb_missing_min, nb_missing_max, nb_evacuated_min, nb_evacuated_max, continent, country, population_density)
FROM 'C:/Mailys/data/hazminer/S20170101000000_E20240101000000_GDELT_Paragraphs_v3.csv'
DELIMITER ',' 
CSV HEADER
QUOTE '"';

DELETE FROM paragraphs2017_23 WHERE longitude IS NULL;
UPDATE paragraphs2017_23 SET wkt=concat('POINT (',longitude,' ',latitude,')');
UPDATE paragraphs2017_23 SET geom=ST_GeomFromText(wkt);
UPDATE paragraphs2017_23 SET country_found = c.admin FROM countries c WHERE ST_Contains(c.geom, paragraphs2017_23.geom);

DROP TABLE IF EXISTS public.paragraphs2017_23_clean;

CREATE TABLE IF NOT EXISTS paragraphs2017_23_clean AS
SELECT DISTINCT ON (paragraph_id) *
FROM paragraphs2017_23
ORDER BY paragraph_id, primary_key;

DROP TABLE IF EXISTS paragraphs2017_23;

ALTER TABLE paragraphs2017_23_clean
RENAME TO paragraphs2017_23;

-- Index: paragraphs2017_23_geom_idx

DROP INDEX IF EXISTS public.paragraphs2017_23_geom_idx;

CREATE INDEX IF NOT EXISTS paragraphs2017_23_geom_idx
    ON public.paragraphs2017_23 USING gist
    (geom)
    WITH (buffering=auto)
    TABLESPACE pg_default;
	
-- Index: paragraphs2017_23_paragraph_id_idx

DROP INDEX IF EXISTS public.paragraphs2017_23_paragraph_id_idx;

CREATE INDEX IF NOT EXISTS paragraphs2017_23_paragraph_id_idx
    ON public.paragraphs2017_23 USING btree
    (paragraph_id ASC NULLS LAST)
    TABLESPACE pg_default;



-- Table: public.event_paragraphs

DROP MATERIALIZED VIEW IF EXISTS vue_paragraphs_pg;

DROP TABLE IF EXISTS public.event_paragraphs;

CREATE TABLE IF NOT EXISTS public.event_paragraphs
(
    event_id character varying(50) COLLATE pg_catalog."default" NOT NULL,
    paragraph_id character varying(50) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT event_paragraphs_pkey PRIMARY KEY (event_id, paragraph_id)
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS public.event_paragraphs
    OWNER to postgres;

-- Index: event_paragraphs_event_id_idx

DROP INDEX IF EXISTS public.event_paragraphs_event_id_idx;

CREATE INDEX IF NOT EXISTS event_paragraphs_event_id_idx
    ON public.event_paragraphs USING btree
    (event_id COLLATE pg_catalog."default" ASC NULLS LAST)
    WITH (deduplicate_items=True)
    TABLESPACE pg_default;

-- Index: event_paragraphs_paragraph_id_idx

DROP INDEX IF EXISTS public.event_paragraphs_paragraph_id_idx;

CREATE INDEX IF NOT EXISTS event_paragraphs_paragraph_id_idx
    ON public.event_paragraphs USING btree
    (paragraph_id COLLATE pg_catalog."default" ASC NULLS LAST)
    WITH (deduplicate_items=True)
    TABLESPACE pg_default;

INSERT INTO event_paragraphs (event_id, paragraph_id)
SELECT event_id, UNNEST(string_to_array(trim(both '{}' from paragraphs_list), ','))
FROM public.events2017_23;



-- Table: public.events

DROP TABLE IF EXISTS public.events;

SELECT event_id, n_paragraphs, n_articles, hazard_type, hazard_score, latitude, longitude, min_lat, max_lat, min_lon, max_lon, event_time, start_time, end_time, duration, n_languages, n_source_countries, n_domains, mostfreq_death, n_mostfreq_death, time_mostfreq_death, median_death, mostfreq_homeless, n_mostfreq_homeless, time_mostfreq_homeless, median_homeless, mostfreq_injured, n_mostfreq_injured, time_mostfreq_injured, median_injured, mostfreq_affected, n_mostfreq_affected, time_mostfreq_affected, median_affected, mostfreq_missing, n_mostfreq_missing, time_mostfreq_missing, median_missing, mostfreq_evacuated, n_mostfreq_evacuated, time_mostfreq_evacuated, median_evacuated, geom, primary_key, country_found
INTO events
FROM public.events2017_23;

-- Index: events_geom_idx

DROP INDEX IF EXISTS public.events_geom_idx;

CREATE INDEX IF NOT EXISTS events_geom_idx
    ON public.events USING gist
    (geom)
    WITH (buffering=auto)
    TABLESPACE pg_default;

ALTER TABLE events ADD PRIMARY KEY (primary_key);



-- Table: public.paragraphs

DROP TABLE IF EXISTS public.paragraphs;

SELECT article_id, title, extracted_text, paragraph_time, article_language, source_country, domain_url, paragraph_id, original_text, disaster_label, disaster_score, hazard_type, hazard_type_score, nb_death, score_death, answer_death, nb_homeless, score_homeless, answer_homeless, nb_injured, score_injured, answer_injured, nb_affected, score_affected, answer_affected, nb_missing, score_missing, answer_missing, nb_evacuated, score_evacuated, answer_evacuated, publication_time, extracted_location, ner_score, latitude, longitude, std_dev, min_lat, max_lat, min_lon, max_lon, n_locations, nb_death_min, nb_death_max, nb_homeless_min, nb_homeless_max, nb_injured_min, nb_injured_max, nb_affected_min ,nb_affected_max, nb_missing_min, nb_missing_max, nb_evacuated_min, nb_evacuated_max, continent, country, population_density, geom, primary_key, country_found
INTO paragraphs
FROM public.paragraphs2017_23;

-- Index: paragraphs_geom_idx

DROP INDEX IF EXISTS public.paragraphs_geom_idx;

CREATE INDEX IF NOT EXISTS paragraphs_geom_idx
    ON public.paragraphs USING gist
    (geom)
    WITH (buffering=auto)
    TABLESPACE pg_default;

-- Index: paragraphs_paragraph_id_idx

DROP INDEX IF EXISTS public.paragraphs_paragraph_id_idx;

CREATE INDEX IF NOT EXISTS paragraphs_paragraph_id_idx
    ON public.paragraphs USING btree
    (paragraph_id ASC NULLS LAST)
    TABLESPACE pg_default;

ALTER TABLE paragraphs ADD PRIMARY KEY (primary_key);



-- Materialized view : public.vue_paragraphs_pg

DROP MATERIALIZED VIEW IF EXISTS vue_paragraphs_pg;

CREATE MATERIALIZED VIEW IF NOT EXISTS vue_paragraphs_pg AS
SELECT 
    (p.paragraph_id || '_' || ep.event_id) AS composite_id, ep.event_id, p.*
FROM 
    paragraphs p
JOIN 
    event_paragraphs ep ON p.paragraph_id = ep.paragraph_id;

-- Index: vue_paragraphs_pg_composite_id_idx

DROP INDEX IF EXISTS public.vue_paragraphs_pg_composite_id_idx;

CREATE UNIQUE INDEX IF NOT EXISTS vue_paragraphs_pg_composite_id_idx
    ON public.vue_paragraphs_pg USING btree
    (composite_id ASC NULLS LAST)
    TABLESPACE pg_default;

-- Index: vue_paragraphs_pg_geom_idx

DROP INDEX IF EXISTS public.vue_paragraphs_pg_geom_idx;

CREATE INDEX IF NOT EXISTS vue_paragraphs_pg_geom_idx
    ON public.vue_paragraphs_pg USING gist
    (geom)
    WITH (buffering=auto)
    TABLESPACE pg_default;

-- Index: vue_paragraphs_pg_event_id_idx

DROP INDEX IF EXISTS public.vue_paragraphs_pg_event_id_idx;

CREATE INDEX IF NOT EXISTS vue_paragraphs_pg_event_id_idx
    ON public.vue_paragraphs_pg USING btree
    (event_id ASC NULLS LAST)
    TABLESPACE pg_default;



-- Table: public.citizen_observer_coord_territoires

DROP TABLE IF EXISTS public.citizen_observer_coord_territoires;

CREATE TABLE IF NOT EXISTS public.citizen_observer_coord_territoires
(
territoire character varying COLLATE pg_catalog."default",
latitude real,
longitude real
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS public.citizen_observer_coord_territoires
    OWNER to postgres;

COPY citizen_observer_coord_territoires (territoire, latitude, longitude)
FROM 'C:/Mailys/data/citizen_observer/citizen_observer_territoires_coord.csv'
DELIMITER ';' 
CSV HEADER
QUOTE '"';



-- Table: public.citizen_observer

DROP TABLE IF EXISTS public.citizen_observer;

CREATE TABLE IF NOT EXISTS public.citizen_observer
(
to_delete_1 timestamp without time zone,
to_delete_2 timestamp without time zone,
today timestamp without time zone,
to_delete_4 character varying COLLATE pg_catalog."default",
to_delete_5 character varying COLLATE pg_catalog."default",
province character varying COLLATE pg_catalog."default",
territoire character varying COLLATE pg_catalog."default",
nom_collectivite_commune character varying COLLATE pg_catalog."default",
nom_groupement_quartier character varying COLLATE pg_catalog."default",
noms_villages character varying COLLATE pg_catalog."default",
type_event character varying COLLATE pg_catalog."default",
landslide_new_or_old character varying COLLATE pg_catalog."default",
to_delete_13 character varying COLLATE pg_catalog."default",
to_delete_14 character varying COLLATE pg_catalog."default",
to_delete_15 character varying COLLATE pg_catalog."default",
to_delete_16 character varying COLLATE pg_catalog."default",
to_delete_17 character varying COLLATE pg_catalog."default",
to_delete_18 character varying COLLATE pg_catalog."default",
to_delete_19 character varying COLLATE pg_catalog."default",
to_delete_20 character varying COLLATE pg_catalog."default",
to_delete_21 character varying COLLATE pg_catalog."default",
to_delete_22 character varying COLLATE pg_catalog."default",
to_delete_23 character varying COLLATE pg_catalog."default",
latitude real,
longitude real,
to_delete_26 character varying COLLATE pg_catalog."default",
to_delete_27 character varying COLLATE pg_catalog."default",
to_delete_28 character varying COLLATE pg_catalog."default",
to_delete_29 character varying COLLATE pg_catalog."default",
to_delete_30 character varying COLLATE pg_catalog."default",
to_delete_31 character varying COLLATE pg_catalog."default",
to_delete_32 character varying COLLATE pg_catalog."default",
to_delete_33 character varying COLLATE pg_catalog."default",
event_date timestamp without time zone,
to_delete_35 character varying COLLATE pg_catalog."default",
to_delete_36 character varying COLLATE pg_catalog."default",
to_delete_37 character varying COLLATE pg_catalog."default",
inondation_duree_jours real,
to_delete_39 character varying COLLATE pg_catalog."default",
to_delete_40 character varying COLLATE pg_catalog."default",
to_delete_41 character varying COLLATE pg_catalog."default",
to_delete_42 character varying COLLATE pg_catalog."default",
to_delete_43 character varying COLLATE pg_catalog."default",
inondation_apres character varying COLLATE pg_catalog."default",
to_delete_45 character varying COLLATE pg_catalog."default",
to_delete_46 character varying COLLATE pg_catalog."default",
to_delete_47 character varying COLLATE pg_catalog."default",
to_delete_48 character varying COLLATE pg_catalog."default",
to_delete_49 character varying COLLATE pg_catalog."default",
to_delete_50 character varying COLLATE pg_catalog."default",
inondation_apres_1 character varying COLLATE pg_catalog."default",
to_delete_52 character varying COLLATE pg_catalog."default",
to_delete_53 character varying COLLATE pg_catalog."default",
grele_duree_minutes real,
to_delete_55 character varying COLLATE pg_catalog."default",
to_delete_56 character varying COLLATE pg_catalog."default",
vents_violents_duree_jours real,
to_delete_58 character varying COLLATE pg_catalog."default",
to_delete_59 character varying COLLATE pg_catalog."default",
to_delete_60 character varying COLLATE pg_catalog."default",
to_delete_61 character varying COLLATE pg_catalog."default",
vents_violents_avec_autre_event character varying COLLATE pg_catalog."default",
vents_violents_avec_autre_event_1 character varying COLLATE pg_catalog."default",
to_delete_64 character varying COLLATE pg_catalog."default",
to_delete_65 character varying COLLATE pg_catalog."default",
to_delete_66 character varying COLLATE pg_catalog."default",
to_delete_67 character varying COLLATE pg_catalog."default",
to_delete_68 character varying COLLATE pg_catalog."default",
to_delete_69 character varying COLLATE pg_catalog."default",
to_delete_70 character varying COLLATE pg_catalog."default",
to_delete_71 character varying COLLATE pg_catalog."default",
to_delete_72 character varying COLLATE pg_catalog."default",
to_delete_73 character varying COLLATE pg_catalog."default",
to_delete_74 character varying COLLATE pg_catalog."default",
to_delete_75 character varying COLLATE pg_catalog."default",
to_delete_76 character varying COLLATE pg_catalog."default",
tdt_duree character varying COLLATE pg_catalog."default",
to_delete_78 character varying COLLATE pg_catalog."default",
to_delete_79 character varying COLLATE pg_catalog."default",
to_delete_80 character varying COLLATE pg_catalog."default",
to_delete_81 character varying COLLATE pg_catalog."default",
to_delete_82 character varying COLLATE pg_catalog."default",
to_delete_83 character varying COLLATE pg_catalog."default",
to_delete_84 character varying COLLATE pg_catalog."default",
to_delete_85 character varying COLLATE pg_catalog."default",
to_delete_86 character varying COLLATE pg_catalog."default",
to_delete_87 character varying COLLATE pg_catalog."default",
to_delete_88 character varying COLLATE pg_catalog."default",
to_delete_89 character varying COLLATE pg_catalog."default",
to_delete_90 character varying COLLATE pg_catalog."default",
to_delete_91 character varying COLLATE pg_catalog."default",
landslide_react_signes character varying COLLATE pg_catalog."default",
landslide_react_signes_1 character varying COLLATE pg_catalog."default",
to_delete_94 character varying COLLATE pg_catalog."default",
to_delete_95 character varying COLLATE pg_catalog."default",
to_delete_96 character varying COLLATE pg_catalog."default",
to_delete_97 character varying COLLATE pg_catalog."default",
landslide_react_signes_2 character varying COLLATE pg_catalog."default",
landslide_apres character varying COLLATE pg_catalog."default",
to_delete_100 character varying COLLATE pg_catalog."default",
to_delete_101 character varying COLLATE pg_catalog."default",
to_delete_102 character varying COLLATE pg_catalog."default",
to_delete_103 character varying COLLATE pg_catalog."default",
to_delete_104 character varying COLLATE pg_catalog."default",
landslide_cause_habitants character varying COLLATE pg_catalog."default",
to_delete_106 character varying COLLATE pg_catalog."default",
to_delete_107 character varying COLLATE pg_catalog."default",
to_delete_108 character varying COLLATE pg_catalog."default",
to_delete_109 character varying COLLATE pg_catalog."default",
to_delete_110 character varying COLLATE pg_catalog."default",
landslide_cause_habitants_1 character varying COLLATE pg_catalog."default",
to_delete_112 character varying COLLATE pg_catalog."default",
to_delete_113 character varying COLLATE pg_catalog."default",
to_delete_114 character varying COLLATE pg_catalog."default",
to_delete_115 character varying COLLATE pg_catalog."default",
to_delete_116 character varying COLLATE pg_catalog."default",
to_delete_117 character varying COLLATE pg_catalog."default",
to_delete_118 character varying COLLATE pg_catalog."default",
to_delete_119 character varying COLLATE pg_catalog."default",
surprise_population character varying COLLATE pg_catalog."default",
nb_morts real,
to_delete_122 character varying COLLATE pg_catalog."default",
nb_blesses real,
nb_sansabris real,
to_delete_125 character varying COLLATE pg_catalog."default",
impact_betail character varying COLLATE pg_catalog."default",
impact_betail_1 character varying COLLATE pg_catalog."default",
to_delete_128 character varying COLLATE pg_catalog."default",
to_delete_129 character varying COLLATE pg_catalog."default",
to_delete_130 character varying COLLATE pg_catalog."default",
to_delete_131 character varying COLLATE pg_catalog."default",
to_delete_132 character varying COLLATE pg_catalog."default",
to_delete_133 character varying COLLATE pg_catalog."default",
to_delete_134 character varying COLLATE pg_catalog."default",
to_delete_135 character varying COLLATE pg_catalog."default",
to_delete_136 character varying COLLATE pg_catalog."default",
to_delete_137 character varying COLLATE pg_catalog."default",
to_delete_138 character varying COLLATE pg_catalog."default",
impact_betail_2 character varying COLLATE pg_catalog."default",
to_delete_140 character varying COLLATE pg_catalog."default",
impact_logement character varying COLLATE pg_catalog."default",
to_delete_142 character varying COLLATE pg_catalog."default",
to_delete_143 character varying COLLATE pg_catalog."default",
to_delete_144 character varying COLLATE pg_catalog."default",
to_delete_145 character varying COLLATE pg_catalog."default",
to_delete_146 character varying COLLATE pg_catalog."default",
to_delete_147 character varying COLLATE pg_catalog."default",
to_delete_148 character varying COLLATE pg_catalog."default",
to_delete_149 character varying COLLATE pg_catalog."default",
to_delete_150 character varying COLLATE pg_catalog."default",
to_delete_151 character varying COLLATE pg_catalog."default",
to_delete_152 character varying COLLATE pg_catalog."default",
to_delete_153 character varying COLLATE pg_catalog."default",
to_delete_154 character varying COLLATE pg_catalog."default",
to_delete_155 character varying COLLATE pg_catalog."default",
to_delete_156 character varying COLLATE pg_catalog."default",
to_delete_157 character varying COLLATE pg_catalog."default",
to_delete_158 character varying COLLATE pg_catalog."default",
to_delete_159 character varying COLLATE pg_catalog."default",
to_delete_160 character varying COLLATE pg_catalog."default",
to_delete_161 character varying COLLATE pg_catalog."default",
to_delete_162 character varying COLLATE pg_catalog."default",
to_delete_163 character varying COLLATE pg_catalog."default",
to_delete_164 character varying COLLATE pg_catalog."default",
to_delete_165 character varying COLLATE pg_catalog."default",
to_delete_166 character varying COLLATE pg_catalog."default",
to_delete_167 character varying COLLATE pg_catalog."default",
to_delete_168 character varying COLLATE pg_catalog."default",
to_delete_169 character varying COLLATE pg_catalog."default",
to_delete_170 character varying COLLATE pg_catalog."default",
to_delete_171 character varying COLLATE pg_catalog."default",
to_delete_172 character varying COLLATE pg_catalog."default",
to_delete_173 character varying COLLATE pg_catalog."default",
to_delete_174 character varying COLLATE pg_catalog."default",
to_delete_175 character varying COLLATE pg_catalog."default",
to_delete_176 character varying COLLATE pg_catalog."default",
to_delete_177 character varying COLLATE pg_catalog."default",
impact_routes character varying COLLATE pg_catalog."default",
to_delete_179 character varying COLLATE pg_catalog."default",
to_delete_180 character varying COLLATE pg_catalog."default",
to_delete_181 character varying COLLATE pg_catalog."default",
to_delete_182 character varying COLLATE pg_catalog."default",
to_delete_183 character varying COLLATE pg_catalog."default",
to_delete_184 character varying COLLATE pg_catalog."default",
to_delete_185 character varying COLLATE pg_catalog."default",
to_delete_186 character varying COLLATE pg_catalog."default",
to_delete_187 character varying COLLATE pg_catalog."default",
to_delete_188 character varying COLLATE pg_catalog."default",
to_delete_189 character varying COLLATE pg_catalog."default",
to_delete_190 character varying COLLATE pg_catalog."default",
to_delete_191 character varying COLLATE pg_catalog."default",
to_delete_192 character varying COLLATE pg_catalog."default",
to_delete_193 character varying COLLATE pg_catalog."default",
impact_ponts character varying COLLATE pg_catalog."default",
to_delete_195 character varying COLLATE pg_catalog."default",
to_delete_196 character varying COLLATE pg_catalog."default",
to_delete_197 character varying COLLATE pg_catalog."default",
to_delete_198 character varying COLLATE pg_catalog."default",
to_delete_199 character varying COLLATE pg_catalog."default",
to_delete_200 character varying COLLATE pg_catalog."default",
to_delete_201 character varying COLLATE pg_catalog."default",
to_delete_202 character varying COLLATE pg_catalog."default",
impact_autres character varying COLLATE pg_catalog."default",
to_delete_204 character varying COLLATE pg_catalog."default",
to_delete_205 character varying COLLATE pg_catalog."default",
to_delete_206 character varying COLLATE pg_catalog."default",
to_delete_207 character varying COLLATE pg_catalog."default",
to_delete_208 character varying COLLATE pg_catalog."default",
to_delete_209 character varying COLLATE pg_catalog."default",
to_delete_210 character varying COLLATE pg_catalog."default",
impact_autres_1 character varying COLLATE pg_catalog."default",
to_delete_212 character varying COLLATE pg_catalog."default",
to_delete_213 character varying COLLATE pg_catalog."default",
to_delete_214 character varying COLLATE pg_catalog."default",
to_delete_215 character varying COLLATE pg_catalog."default",
to_delete_216 character varying COLLATE pg_catalog."default",
to_delete_217 character varying COLLATE pg_catalog."default",
to_delete_218 character varying COLLATE pg_catalog."default",
impact_coupures_elec character varying COLLATE pg_catalog."default",
impact_eau_consommation character varying COLLATE pg_catalog."default",
to_delete_221 character varying COLLATE pg_catalog."default",
tdt_declenche_landslide character varying COLLATE pg_catalog."default",
to_delete_223 character varying COLLATE pg_catalog."default",
impact_cultures character varying COLLATE pg_catalog."default",
impact_cultures_1 character varying COLLATE pg_catalog."default",
to_delete_226 character varying COLLATE pg_catalog."default",
to_delete_227 character varying COLLATE pg_catalog."default",
to_delete_228 character varying COLLATE pg_catalog."default",
to_delete_229 character varying COLLATE pg_catalog."default",
to_delete_230 character varying COLLATE pg_catalog."default",
to_delete_231 character varying COLLATE pg_catalog."default",
to_delete_232 character varying COLLATE pg_catalog."default",
to_delete_233 character varying COLLATE pg_catalog."default",
to_delete_234 character varying COLLATE pg_catalog."default",
to_delete_235 character varying COLLATE pg_catalog."default",
to_delete_236 character varying COLLATE pg_catalog."default",
to_delete_237 character varying COLLATE pg_catalog."default",
to_delete_238 character varying COLLATE pg_catalog."default",
to_delete_239 character varying COLLATE pg_catalog."default",
to_delete_240 character varying COLLATE pg_catalog."default",
to_delete_241 character varying COLLATE pg_catalog."default",
to_delete_242 character varying COLLATE pg_catalog."default",
to_delete_243 character varying COLLATE pg_catalog."default",
to_delete_244 character varying COLLATE pg_catalog."default",
validation_status character varying COLLATE pg_catalog."default",
to_delete_246 character varying COLLATE pg_catalog."default",
to_delete_247 character varying COLLATE pg_catalog."default",
to_delete_248 character varying COLLATE pg_catalog."default",
to_delete_249 character varying COLLATE pg_catalog."default",
to_delete_250 character varying COLLATE pg_catalog."default",
donnees_georeferencees boolean,
wkt character varying COLLATE pg_catalog."default",
geom geometry(Point,4326),
primary_key integer NOT NULL GENERATED ALWAYS AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
pays character varying COLLATE pg_catalog."default",
CONSTRAINT citizen_observer_pkey PRIMARY KEY (primary_key)
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS public.citizen_observer 
    OWNER to postgres;

COPY citizen_observer (to_delete_1, to_delete_2, today, to_delete_4, to_delete_5, province, territoire, nom_collectivite_commune, nom_groupement_quartier, noms_villages, type_event, landslide_new_or_old, to_delete_13, to_delete_14, to_delete_15, to_delete_16, to_delete_17, to_delete_18, to_delete_19, to_delete_20, to_delete_21, to_delete_22, to_delete_23, latitude, longitude, to_delete_26, to_delete_27, to_delete_28, to_delete_29, to_delete_30, to_delete_31, to_delete_32, to_delete_33, event_date, to_delete_35, to_delete_36, to_delete_37, inondation_duree_jours, to_delete_39, to_delete_40, to_delete_41, to_delete_42, to_delete_43, inondation_apres, to_delete_45, to_delete_46, to_delete_47, to_delete_48, to_delete_49, to_delete_50, inondation_apres_1, to_delete_52, to_delete_53, grele_duree_minutes, to_delete_55, to_delete_56, vents_violents_duree_jours, to_delete_58, to_delete_59, to_delete_60, to_delete_61, vents_violents_avec_autre_event, vents_violents_avec_autre_event_1, to_delete_64, to_delete_65, to_delete_66, to_delete_67, to_delete_68, to_delete_69, to_delete_70, to_delete_71, to_delete_72, to_delete_73, to_delete_74, to_delete_75, to_delete_76, tdt_duree, to_delete_78, to_delete_79, to_delete_80, to_delete_81, to_delete_82, to_delete_83, to_delete_84, to_delete_85, to_delete_86, to_delete_87, to_delete_88, to_delete_89, to_delete_90, to_delete_91, landslide_react_signes, landslide_react_signes_1, to_delete_94, to_delete_95, to_delete_96, to_delete_97, landslide_react_signes_2, landslide_apres, to_delete_100, to_delete_101, to_delete_102, to_delete_103, to_delete_104, landslide_cause_habitants, to_delete_106, to_delete_107, to_delete_108, to_delete_109, to_delete_110, landslide_cause_habitants_1, to_delete_112, to_delete_113, to_delete_114, to_delete_115, to_delete_116, to_delete_117, to_delete_118, to_delete_119, surprise_population, nb_morts, to_delete_122, nb_blesses, nb_sansabris, to_delete_125, impact_betail, impact_betail_1, to_delete_128, to_delete_129, to_delete_130, to_delete_131, to_delete_132, to_delete_133, to_delete_134, to_delete_135, to_delete_136, to_delete_137, to_delete_138, impact_betail_2, to_delete_140, impact_logement, to_delete_142, to_delete_143, to_delete_144, to_delete_145, to_delete_146, to_delete_147, to_delete_148, to_delete_149, to_delete_150, to_delete_151, to_delete_152, to_delete_153, to_delete_154, to_delete_155, to_delete_156, to_delete_157, to_delete_158, to_delete_159, to_delete_160, to_delete_161, to_delete_162, to_delete_163, to_delete_164,to_delete_165, to_delete_166, to_delete_167, to_delete_168, to_delete_169, to_delete_170, to_delete_171, to_delete_172, to_delete_173, to_delete_174, to_delete_175, to_delete_176, to_delete_177, impact_routes, to_delete_179, to_delete_180, to_delete_181, to_delete_182, to_delete_183, to_delete_184, to_delete_185, to_delete_186, to_delete_187, to_delete_188, to_delete_189, to_delete_190, to_delete_191, to_delete_192, to_delete_193, impact_ponts, to_delete_195, to_delete_196, to_delete_197, to_delete_198, to_delete_199, to_delete_200, to_delete_201, to_delete_202, impact_autres, to_delete_204, to_delete_205, to_delete_206, to_delete_207, to_delete_208, to_delete_209, to_delete_210, impact_autres_1, to_delete_212, to_delete_213, to_delete_214, to_delete_215, to_delete_216, to_delete_217, to_delete_218, impact_coupures_elec, impact_eau_consommation, to_delete_221, tdt_declenche_landslide, to_delete_223, impact_cultures, impact_cultures_1, to_delete_226, to_delete_227, to_delete_228, to_delete_229, to_delete_230, to_delete_231, to_delete_232, to_delete_233, to_delete_234, to_delete_235, to_delete_236, to_delete_237, to_delete_238, to_delete_239, to_delete_240, to_delete_241, to_delete_242, to_delete_243, to_delete_244, validation_status, to_delete_246, to_delete_247, to_delete_248, to_delete_249, to_delete_250)
FROM 'C:/Mailys/data/citizen_observer/citizen_observer_data.csv'
DELIMITER ';' 
CSV HEADER
QUOTE '"';

DO $$
DECLARE
    col_record RECORD;
    alter_command TEXT;
BEGIN
    FOR col_record IN
        SELECT column_name
        FROM information_schema.columns
        WHERE table_name = 'citizen_observer'
        AND column_name LIKE 'to_delete_%'
    LOOP
        alter_command := 'ALTER TABLE citizen_observer DROP COLUMN ' || col_record.column_name || ';';
        EXECUTE alter_command;
        RAISE NOTICE 'Suppression de la colonne %', col_record.column_name;
    END LOOP;
END $$;

DELETE FROM citizen_observer WHERE validation_status != 'Approved';
DELETE FROM citizen_observer WHERE validation_status IS NULL; 

UPDATE citizen_observer SET event_date=today WHERE event_date IS NULL;

UPDATE citizen_observer SET donnees_georeferencees=false WHERE latitude IS null;
UPDATE citizen_observer SET donnees_georeferencees=true WHERE donnees_georeferencees IS NULL;
UPDATE citizen_observer SET latitude = citizen_observer_coord_territoires.latitude FROM citizen_observer_coord_territoires WHERE citizen_observer.territoire = citizen_observer_coord_territoires.territoire AND citizen_observer.donnees_georeferencees = false;
UPDATE citizen_observer SET longitude = citizen_observer_coord_territoires.longitude FROM citizen_observer_coord_territoires WHERE citizen_observer.territoire = citizen_observer_coord_territoires.territoire AND citizen_observer.donnees_georeferencees = false;
UPDATE citizen_observer SET wkt=concat('POINT (',longitude,' ',latitude,')');
UPDATE citizen_observer SET geom=ST_GeomFromText(wkt);
UPDATE citizen_observer SET pays = 'République démocratique du Congo';

UPDATE citizen_observer SET impact_betail_1 = REPLACE(impact_betail_1,'autre',impact_betail_2) WHERE impact_betail_2 IS NOT NULL;
ALTER TABLE citizen_observer DROP COLUMN impact_betail_2;
UPDATE citizen_observer SET impact_betail = REPLACE(impact_betail,'oui',concat('oui (',impact_betail_1,')')) WHERE impact_betail = 'oui';
ALTER TABLE citizen_observer DROP COLUMN impact_betail_1;

UPDATE citizen_observer SET impact_autres = REPLACE(impact_autres,'publiques','publics');
UPDATE citizen_observer SET impact_autres = REPLACE(impact_autres,' non, rien d''autre affecté','') WHERE impact_autres LIKE '% non, rien d''autre affecté%';
UPDATE citizen_observer SET impact_autres = REPLACE(impact_autres,'non, rien d''autre affecté ','') WHERE impact_autres LIKE '%non, rien d''autre affecté %';
UPDATE citizen_observer SET impact_autres = REPLACE(impact_autres,'autres infrastructures',impact_autres_1) WHERE impact_autres_1 IS NOT NULL;
ALTER TABLE citizen_observer DROP COLUMN impact_autres_1;
UPDATE citizen_observer SET impact_autres = REPLACE(impact_autres,'non, rien d''autre affecté','non');
UPDATE citizen_observer SET impact_autres = REPLACE(impact_autres,impact_autres,concat('oui (',impact_autres,')')) WHERE impact_autres != 'non';

UPDATE citizen_observer SET impact_coupures_elec = 'non' WHERE impact_coupures_elec IS NULL;

UPDATE citizen_observer SET impact_cultures = REPLACE(impact_cultures,'oui',concat('oui (',impact_cultures_1,')')) WHERE impact_cultures = 'oui';
ALTER TABLE citizen_observer DROP COLUMN impact_cultures_1;

UPDATE citizen_observer SET vents_violents_avec_autre_event = REPLACE(vents_violents_avec_autre_event,'Oui',concat('Oui (',vents_violents_avec_autre_event_1,')')) WHERE vents_violents_avec_autre_event = 'Oui';
ALTER TABLE citizen_observer DROP COLUMN vents_violents_avec_autre_event_1;

UPDATE citizen_observer SET inondation_apres = REPLACE(inondation_apres,'autre événement',inondation_apres_1) WHERE inondation_apres_1 IS NOT NULL;
ALTER TABLE citizen_observer DROP COLUMN inondation_apres_1;

UPDATE citizen_observer SET landslide_react_signes = 'non' WHERE landslide_react_signes IS NULL;
UPDATE citizen_observer SET landslide_react_signes_1 = REPLACE(landslide_react_signes_1,'autre',landslide_react_signes_2) WHERE landslide_react_signes_2 IS NOT NULL;
ALTER TABLE citizen_observer DROP COLUMN landslide_react_signes_2;
UPDATE citizen_observer SET landslide_react_signes = REPLACE(landslide_react_signes,'oui',concat('oui (',landslide_react_signes_1,')')) WHERE landslide_react_signes = 'oui';
ALTER TABLE citizen_observer DROP COLUMN landslide_react_signes_1;

UPDATE citizen_observer SET landslide_cause_habitants = REPLACE(landslide_cause_habitants,'une autre cause',landslide_cause_habitants_1) WHERE landslide_cause_habitants_1 IS NOT NULL;
ALTER TABLE citizen_observer DROP COLUMN landslide_cause_habitants_1;
